<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MiniBus with Awaitable Wiring</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- MiniState -->
  <script>
    // ministate.js
    const MiniState = (() => {
      let state = {};
      const watchers = {};
      const predefinedStates = {};

      return {
        addState(stateName, stateDefinition) {
          predefinedStates[stateName] = stateDefinition;
        },

        init(initialStateKey = "SIDEBAR_HIDDEN") {
          const initialState = predefinedStates[initialStateKey];
          if (!initialState) {
            console.error(`Initial state "${initialStateKey}" is not defined.`);
            return;
          }

          Object.keys(initialState).forEach(elementId => {
            const attributes = initialState[elementId];
            Object.keys(attributes).forEach(attr => {
              const stateKey = `${elementId}.${attr}`;
              state[stateKey] = attributes[attr];
            });
          });

          console.log('Initial State:', JSON.stringify(state, null, 2));
        },

        getState(stateKey) {
          return state[stateKey];
        },

        setState(stateKey, newValue) {
          if (state[stateKey] !== newValue) {
            state[stateKey] = newValue;
            this._notify(stateKey, newValue);
          }
        },

        watch(stateKey, callback) {
          if (!watchers[stateKey]) watchers[stateKey] = [];
          watchers[stateKey].push(callback);
        },

        _notify(stateKey, newValue) {
          if (watchers[stateKey]) {
            watchers[stateKey].forEach(callback => callback(newValue));
          }
        },

        switchState(stateName) {
          const newState = predefinedStates[stateName];
          if (!newState) {
            console.error(`State "${stateName}" is not defined.`);
            return;
          }

          Object.keys(newState).forEach(elementId => {
            const attributes = newState[elementId];
            Object.keys(attributes).forEach(attr => {
              const stateKey = `${elementId}.${attr}`;
              this.setState(stateKey, attributes[attr]);
            });
          });
        }
      };
    })();
  </script>
  
  <!-- MiniBus -->
  <script>
    // minibus.js
    const MiniBus = (() => {
      const wiring = {};
      const permissions = {};

      return {
        init(initialStateKey = "SIDEBAR_HIDDEN") {
          MiniState.init(initialStateKey);
        },

        wire(elementId, dataAttribute, domProperty) {
          wiring[`${elementId}.${dataAttribute}`] = domProperty;
          const stateKey = `${elementId}.${dataAttribute}`;
          const currentValue = MiniState.getState(stateKey);
          this._applyStateChange(elementId, dataAttribute, currentValue);

          MiniState.watch(stateKey, (newValue) => {
            this._applyStateChange(elementId, dataAttribute, newValue);
          });
        },

        grantPermission(ownerId, stateKey) {
          if (!permissions[stateKey]) permissions[stateKey] = [];
          if (!permissions[stateKey].includes(ownerId)) {
            permissions[stateKey].push(ownerId);
          }
        },

        requestStateChange(ownerId, stateKey, newValue) {
          if (permissions[stateKey] && permissions[stateKey].includes(ownerId)) {
            MiniState.setState(stateKey, newValue);
          } else {
            console.error(`Permission denied: ${ownerId} cannot modify ${stateKey}`);
          }
        },

        _applyStateChange(elementId, dataAttribute, newValue) {
          const element = document.getElementById(elementId);
          if (!element) return;

          const domProperty = wiring[`${elementId}.${dataAttribute}`];
          if (domProperty) {
            if (domProperty === "classList.hidden") {
              newValue === "hidden" ? element.classList.add("hidden") : element.classList.remove("hidden");
            } else {
              element[domProperty] = newValue;
            }
          }
        },

        registerEvent(componentId, eventType, stateKeyToChange) {
          const element = document.getElementById(componentId);
          if (!element) return;

          element.addEventListener(eventType, () => {
            const currentValue = MiniState.getState(stateKeyToChange) === "true";
            this.requestStateChange(componentId, stateKeyToChange, (!currentValue).toString());
          });
        }
      };
    })();
  </script>
</head>
<body class="flex">
  
  <!-- Initialization Script -->
  <script>
    // Define and add predefined states
    MiniState.addState("SIDEBAR_HIDDEN", {
      sidebarComponent: {
        "data-class": "hidden"
      },
      toggleButton: {
        "data-text": "Show Sidebar"
      }
    });

    MiniState.addState("SIDEBAR_VISIBLE", {
      sidebarComponent: {
        "data-class": ""
      },
      toggleButton: {
        "data-text": "Hide Sidebar"
      }
    });

    // Initialize MiniBus with the desired initial state
    MiniBus.init("SIDEBAR_HIDDEN");
  </script>

  <!-- Sidebar Component -->
  <div id="sidebarComponent" class="w-64 p-4 mt-6 bg-base-200 hidden" data-class="hidden">
    <p>Sidebar Content</p>
    <script>
      // Sidebar Component Script
      MiniBus.wire("sidebarComponent", "data-class", "classList.hidden");
      MiniBus.grantPermission("buttonComponent", "sidebarComponent.data-class");

      MiniState.watch("buttonComponent.data-click", (value) => {
        MiniBus.requestStateChange("buttonComponent", "sidebarComponent.data-class", value === "true" ? "" : "hidden");
      });
    </script>
  </div>
  
  <!-- Button Component -->
  <div id="buttonComponent" data-click="false">
    <button id="toggleButton" class="btn btn-primary" data-text="Show Sidebar">Show Sidebar</button>
    <script>
      // Button Component Script
      MiniBus.wire("toggleButton", "data-text", "textContent");
      MiniBus.registerEvent("buttonComponent", "click", "buttonComponent.data-click");

      MiniBus.grantPermission("buttonComponent", "toggleButton.data-text");
      MiniBus.grantPermission("buttonComponent", "buttonComponent.data-click");

      MiniState.watch("buttonComponent.data-click", (value) => {
        MiniBus.requestStateChange("buttonComponent", "toggleButton.data-text", value === "true" ? "Hide Sidebar" : "Show Sidebar");
      });
    </script>
  </div>
  
  <script>
    console.log("All components are wired and state is initialized.");
  </script>
</body>
</html>
