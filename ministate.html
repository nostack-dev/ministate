<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MiniBus with FSM</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MiniBus with FSM -->
  <script>
    const MiniBus = (() => {
      const state = {};
      const wiring = {};
      const watchers = {};
      const predefinedStates = {};
      const transitions = {};
      let currentState = "";

      return {
        // Add predefined states
        addState(stateName, stateDefinition) {
          predefinedStates[stateName] = stateDefinition;
        },

        // Add allowed transitions between states
        addTransition(fromState, toState, condition) {
          if (!transitions[fromState]) transitions[fromState] = [];
          transitions[fromState].push({ toState, condition });
        },

        // Initialize MiniBus with the initial state
        init(initialStateKey = "SIDEBAR_HIDDEN") {
          currentState = initialStateKey;
          this._applyState(predefinedStates[initialStateKey]);
          console.log("Initial State:", currentState, JSON.stringify(state, null, 2));
        },

        // Wire elements to update based on state changes
        wire(elementId, dataAttribute, domProperty) {
          wiring[`${elementId}.${dataAttribute}`] = domProperty;
          const stateKey = `${elementId}.${dataAttribute}`;
          const currentValue = state[stateKey];
          this._applyStateChange(elementId, dataAttribute, currentValue);

          this.watch(stateKey, (newValue) => {
            this._applyStateChange(elementId, dataAttribute, newValue);
          });
        },

        // Apply changes to the DOM when the state updates
        _applyStateChange(elementId, dataAttribute, newValue) {
          const element = document.getElementById(elementId);
          if (!element) return;

          const domProperty = wiring[`${elementId}.${dataAttribute}`];
          if (domProperty === "classList.hidden") {
            newValue === "hidden" ? element.classList.add("hidden") : element.classList.remove("hidden");
          } else {
            element[domProperty] = newValue;
          }
        },

        // Request a state transition based on the FSM rules
        requestStateTransition(newState) {
          const allowedTransitions = transitions[currentState] || [];
          const validTransition = allowedTransitions.find(t => t.toState === newState && (!t.condition || t.condition()));

          if (validTransition) {
            currentState = newState;
            this._applyState(predefinedStates[newState]);
            console.log("Transitioned to State:", currentState, JSON.stringify(state, null, 2));
          } else {
            console.error(`Transition from "${currentState}" to "${newState}" not allowed.`);
          }
        },

        // Apply a full state definition to update multiple elements at once
        _applyState(stateDefinition) {
          Object.entries(stateDefinition).forEach(([stateKey, value]) => {
            this.requestStateChange(stateKey, value);
          });
        },

        // Request to update individual state and trigger watchers
        requestStateChange(stateKey, newValue) {
          if (state[stateKey] !== newValue) {
            state[stateKey] = newValue;
            if (watchers[stateKey]) {
              watchers[stateKey].forEach(callback => callback(newValue));
            }
          }
        },

        // Register watchers to listen for specific state changes
        watch(stateKey, callback) {
          if (!watchers[stateKey]) watchers[stateKey] = [];
          watchers[stateKey].push(callback);
        },

        // Attach events that trigger state changes
        registerEvent(elementId, eventType, stateKeyToChange) {
          const element = document.getElementById(elementId);
          if (!element) return;

          element.addEventListener(eventType, () => {
            const currentValue = state[stateKeyToChange] === "true";
            this.requestStateChange(stateKeyToChange, (!currentValue).toString());
          });
        }
      };
    })();

    // Define initial states
    MiniBus.addState("SIDEBAR_HIDDEN", {
      "sidebarComponent.data-class": "hidden",
      "toggleButton.data-text": "Show Sidebar",
      "buttonComponent.data-click": "false"
    });

    MiniBus.addState("SIDEBAR_VISIBLE", {
      "sidebarComponent.data-class": "",
      "toggleButton.data-text": "Hide Sidebar",
      "buttonComponent.data-click": "true"
    });

    // Define transitions between states
    MiniBus.addTransition("SIDEBAR_HIDDEN", "SIDEBAR_VISIBLE", () => true);
    MiniBus.addTransition("SIDEBAR_VISIBLE", "SIDEBAR_HIDDEN", () => true);

    document.addEventListener('DOMContentLoaded', () => {
      MiniBus.init("SIDEBAR_HIDDEN");
    });
  </script>
</head>
<body>

  <!-- Sidebar Component -->
  <div id="sidebarComponent" class="w-64 p-4 mt-6 bg-base-200 hidden" data-class="hidden">
    <p>Sidebar Content</p>
    <script>
      // Wire sidebar to show/hide based on data-class
      MiniBus.wire("sidebarComponent", "data-class", "classList.hidden");

      // Watch button's click state to toggle sidebar visibility using FSM transitions
      MiniBus.watch("buttonComponent.data-click", (value) => {
        MiniBus.requestStateTransition(value === "true" ? "SIDEBAR_VISIBLE" : "SIDEBAR_HIDDEN");
      });
    </script>
  </div>

  <!-- Button Component -->
  <div id="buttonComponent" data-click="false">
    <button id="toggleButton" class="btn btn-primary" data-text="Show Sidebar">Show Sidebar</button>
    <script>
      // Wire button text to update based on data-click
      MiniBus.wire("toggleButton", "data-text", "textContent");

      // Register click event to toggle data-click state
      MiniBus.registerEvent("buttonComponent", "click", "buttonComponent.data-click");

      // Update button text and toggle sidebar state based on click state
      MiniBus.watch("buttonComponent.data-click", (value) => {
        MiniBus.requestStateTransition(value === "true" ? "SIDEBAR_VISIBLE" : "SIDEBAR_HIDDEN");
      });
    </script>
  </div>

</body>
</html>
