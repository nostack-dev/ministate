<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MiniState with FSM</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MiniState with FSM -->
  <script>
    const MiniState = (() => {
      const state = JSON.parse(localStorage.getItem('state')) || {};
      const wiring = {};
      const watchers = {};
      const predefinedStates = {};
      const transitions = {};
      let currentState = "";

      const saveState = () => {
        localStorage.setItem('state', JSON.stringify(state));
      };

      return {
        addState(stateName, stateDefinition) {
          predefinedStates[stateName] = stateDefinition;
        },

        addTransition(fromState, toState, condition) {
          if (!transitions[fromState]) transitions[fromState] = [];
          transitions[fromState].push({ toState, condition });
        },

        async init(initialStateKey = "SIDEBAR_HIDDEN") {
          currentState = initialStateKey;
          await this._applyState(predefinedStates[initialStateKey]);
          console.log("Initial State:", currentState, JSON.stringify(state, null, 2));
        },

        async wire(elementId, dataAttribute, domProperty) {
          wiring[`${elementId}.${dataAttribute}`] = domProperty;
          const stateKey = `${elementId}.${dataAttribute}`;
          const currentValue = state[stateKey];
          await this._applyStateChange(elementId, dataAttribute, currentValue);

          this.watch(stateKey, async (newValue) => {
            await this._applyStateChange(elementId, dataAttribute, newValue);
          });
        },

        async _applyStateChange(elementId, dataAttribute, newValue) {
          const element = document.getElementById(elementId);
          if (!element) return;

          const domProperty = wiring[`${elementId}.${dataAttribute}`];
          if (domProperty === "classList.hidden") {
            newValue === "hidden" ? element.classList.add("hidden") : element.classList.remove("hidden");
          } else {
            element[domProperty] = newValue;
          }
          saveState();
        },

        async requestStateTransition(newState) {
          if (currentState === newState) {
            return;
          }

          const allowedTransitions = transitions[currentState] || [];
          const validTransition = allowedTransitions.find(t => t.toState === newState && (!t.condition || t.condition()));

          if (validTransition) {
            currentState = newState;
            await this._applyState(predefinedStates[newState]);
            console.log("Transitioned to State:", currentState, JSON.stringify(state, null, 2));
          } else {
            console.error(`Transition from "${currentState}" to "${newState}" not allowed.`);
          }
        },

        async _applyState(stateDefinition) {
          for (const [stateKey, value] of Object.entries(stateDefinition)) {
            await this.requestStateChange(stateKey, value);
          }
        },

        async requestStateChange(stateKey, newValue) {
          if (state[stateKey] !== newValue) {
            state[stateKey] = newValue;
            if (watchers[stateKey]) {
              for (const callback of watchers[stateKey]) {
                await callback(newValue);
              }
            }
            saveState();
          }
        },

        watch(stateKey, callback) {
          if (!watchers[stateKey]) watchers[stateKey] = [];
          watchers[stateKey].push(callback);
        },

        registerEvent(elementId, eventType, stateKeyToChange) {
          const element = document.getElementById(elementId);
          if (!element) return;

          element.addEventListener(eventType, async () => {
            const currentValue = state[stateKeyToChange] === "true";
            await this.requestStateChange(stateKeyToChange, (!currentValue).toString());
          });
        }
      };
    })();

    MiniState.addState("SIDEBAR_HIDDEN", {
      "sidebarComponent.data-class": "hidden",
      "buttonComponent.toggleButton.data-text": "Show Sidebar",
      "buttonComponent.data-click": "false"
    });

    MiniState.addState("SIDEBAR_VISIBLE", {
      "sidebarComponent.data-class": "",
      "buttonComponent.toggleButton.data-text": "Hide Sidebar",
      "buttonComponent.data-click": "true"
    });

    MiniState.addTransition("SIDEBAR_HIDDEN", "SIDEBAR_VISIBLE", async () => true);
    MiniState.addTransition("SIDEBAR_VISIBLE", "SIDEBAR_HIDDEN", async () => true);

    document.addEventListener('DOMContentLoaded', async () => {
      await MiniState.init("SIDEBAR_HIDDEN");
    });
  </script>
</head>
<body>

  <!-- Sidebar Component -->
  <div id="sidebarComponent" class="w-64 p-4 mt-6 bg-base-200 hidden" data-class="hidden">
    <p>Sidebar Content</p>
    <script>
      MiniState.wire("sidebarComponent", "data-class", "classList.hidden");

      MiniState.watch("buttonComponent.data-click", async (value) => {
        await MiniState.requestStateTransition(value === "true" ? "SIDEBAR_VISIBLE" : "SIDEBAR_HIDDEN");
      });
    </script>
  </div>

  <!-- Button Component -->
  <div id="buttonComponent" data-click="false">
    <button id="buttonComponent.toggleButton" class="btn btn-primary" data-text="Show Sidebar">Show Sidebar</button>
    <script>
      MiniState.wire("buttonComponent.toggleButton", "data-text", "textContent");

      MiniState.registerEvent("buttonComponent", "click", "buttonComponent.data-click");

      MiniState.watch("buttonComponent.data-click", async (value) => {
        await MiniState.requestStateTransition(value === "true" ? "SIDEBAR_VISIBLE" : "SIDEBAR_HIDDEN");
      });
    </script>
  </div>

</body>
</html>
