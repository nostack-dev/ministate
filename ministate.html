<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Configurable MiniState Library</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MiniState -->
  <script>
    const MiniState = (() => {
      let state = {};
      const watchers = {};
      const wiring = {};
      let transitionInProgress = false;
      let predefinedStates = {};

      return {
        init(externalStates) {
          predefinedStates = externalStates;

          // Initialize state based on DOM
          const sidebarElement = document.getElementById('sidebarComponent');
          const toggleButton = document.getElementById('toggleButton');
          const buttonComponent = document.getElementById('buttonComponent');

          const isSidebarHidden = sidebarElement.classList.contains('hidden');
          state = {
            "sidebarComponent.data-class": isSidebarHidden ? "hidden" : "",
            "toggleButton.data-text": toggleButton.textContent.trim(),
            "buttonComponent.data-click": buttonComponent.getAttribute("data-click") || "false"
          };

          console.log('Initial State:', JSON.stringify(state, null, 2));
        },

        getState(stateKey) {
          return state[stateKey];
        },

        setState(stateKey, newValue) {
          if (state[stateKey] !== newValue) {
            state[stateKey] = newValue;
            this._notify(stateKey, newValue);
          }
        },

        watch(stateKey, callback) {
          if (!watchers[stateKey]) watchers[stateKey] = [];
          watchers[stateKey].push(callback);
        },

        _notify(stateKey, newValue) {
          if (watchers[stateKey]) {
            watchers[stateKey].forEach(callback => callback(newValue));
          }
          console.log(`Partial State Update:`, JSON.stringify({ [stateKey]: newValue }, null, 2));
        },

        wire(elementId, dataAttribute, domProperty, options = {}) {
          wiring[`${elementId}.${dataAttribute}`] = { domProperty, ...options };
          this.watch(`${elementId}.${dataAttribute}`, (newValue) => {
            this._applyStateChange(elementId, dataAttribute, newValue);
          });
        },

        requestStateChange(stateKey, newValue) {
          if (transitionInProgress) return;

          const targetState = newValue === "true" ? "SIDEBAR_VISIBLE" : "SIDEBAR_HIDDEN";
          const targetAttributes = predefinedStates[targetState];

          if (
            targetAttributes &&
            (targetAttributes[stateKey] === newValue || targetAttributes[stateKey] === "" || targetAttributes[stateKey] == null)
          ) {
            transitionInProgress = true;
            console.log(`Transition to ${targetState} matched. Applying changes...`);
            Object.keys(targetAttributes).forEach(attr => {
              this.setState(attr, targetAttributes[attr]);
            });
            transitionInProgress = false;
          } else {
            console.warn(`Invalid state transition for ${stateKey} to ${newValue}`);
          }
        },

        _applyStateChange(elementId, dataAttribute, newValue) {
          const element = document.getElementById(elementId);
          if (!element) return;

          const { domProperty, toggleClass } = wiring[`${elementId}.${dataAttribute}`];

          if (domProperty === "classList" && toggleClass) {
            // Add or remove the specified class based on the newValue
            newValue === toggleClass
              ? element.classList.add(toggleClass)
              : element.classList.remove(toggleClass);
          } else {
            // Set any other DOM property directly
            element[domProperty] = newValue;
          }
        },

        registerEvent(componentId, eventType, stateKeyToChange) {
          const element = document.getElementById(componentId);
          if (!element) return;

          element.addEventListener(eventType, () => {
            const currentValue = this.getState(stateKeyToChange) === "true";
            this.requestStateChange(stateKeyToChange, (!currentValue).toString());
          });
        }
      };
    })();
  </script>
</head>
<body class="flex">

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Define predefined states externally
      const predefinedStates = {
        "SIDEBAR_HIDDEN": {
          "sidebarComponent.data-class": "hidden",
          "toggleButton.data-text": "Show Sidebar",
          "buttonComponent.data-click": "false"
        },
        "SIDEBAR_VISIBLE": {
          "sidebarComponent.data-class": "",
          "toggleButton.data-text": "Hide Sidebar",
          "buttonComponent.data-click": "true"
        }
      };

      // Initialize MiniState with predefined states
      MiniState.init(predefinedStates);
    });
  </script>

  <div id="sidebarComponent" data-state="closed" class="bg-neutral w-64 h-full fixed top-0 left-0 flex flex-col justify-between transform transition-transform duration-300 ease-in-out z-10 hidden">
    <div class="h-16 flex items-center justify-between px-4">
      <button class="toggleSidebarButton text-accent" aria-label="Toggle Sidebar">â˜°</button>
    </div>

    <nav class="flex-1 p-4">
      <ul class="menu w-full">
        <li>sidebar entry</li>
      </ul>
    </nav>

    <script>
      // Wire the sidebar's visibility class, specifying the toggle class explicitly
      MiniState.wire("sidebarComponent", "data-class", "classList", { toggleClass: "hidden" });

      MiniState.watch("buttonComponent.data-click", (value) => {
        MiniState.requestStateChange("sidebarComponent.data-class", value === "true" ? "" : "hidden");
      });
    </script>
  </div>

  <div id="buttonComponent" data-click="false" class="flex justify-center items-center w-full h-full">
    <button id="toggleButton" class="btn btn-primary" data-text="Show Sidebar">Show Sidebar</button>

    <script>
      // Wire the button text content, without any class toggling
      MiniState.wire("toggleButton", "data-text", "textContent");
      MiniState.registerEvent("toggleButton", "click", "buttonComponent.data-click");

      MiniState.watch("buttonComponent.data-click", (value) => {
        MiniState.requestStateChange("toggleButton.data-text", value === "true" ? "Hide Sidebar" : "Show Sidebar");
      });
    </script>
  </div>

</body>
</html>
