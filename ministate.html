<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MiniBus with Controlled Transitions</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MiniState -->
  <script>
    const MiniState = (() => {
      let state = {};
      const watchers = {};
      const predefinedStates = {
        "SIDEBAR_HIDDEN": {
          "sidebarComponent.data-class": "hidden",
          "toggleButton.data-text": "Show Sidebar",
          "buttonComponent.data-click": "false"
        },
        "SIDEBAR_VISIBLE": {
          "sidebarComponent.data-class": "",
          "toggleButton.data-text": "Hide Sidebar",
          "buttonComponent.data-click": "true"
        }
      };

      return {
        init() {
          const sidebarElement = document.getElementById('sidebarComponent');
          const toggleButton = document.getElementById('toggleButton');
          const buttonComponent = document.getElementById('buttonComponent');

          // Initialize state based on DOM
          const isSidebarHidden = sidebarElement.classList.contains('hidden');
          state = {
            "sidebarComponent.data-class": isSidebarHidden ? "hidden" : "",
            "toggleButton.data-text": toggleButton.textContent.trim(),
            "buttonComponent.data-click": buttonComponent.getAttribute("data-click") || "false"
          };

          console.log('Initial State:', JSON.stringify(state, null, 2));
        },

        getState(stateKey) {
          return state[stateKey];
        },

        setState(stateKey, newValue) {
          if (state[stateKey] !== newValue) {
            state[stateKey] = newValue;
            this._notify(stateKey, newValue);
          }
        },

        watch(stateKey, callback) {
          if (!watchers[stateKey]) watchers[stateKey] = [];
          watchers[stateKey].push(callback);
        },

        _notify(stateKey, newValue) {
          if (watchers[stateKey]) {
            watchers[stateKey].forEach(callback => callback(newValue));
          }
          console.log(`Partial State Update:`, JSON.stringify({ [stateKey]: newValue }, null, 2));
        },

        predefinedStates: predefinedStates
      };
    })();
  </script>

  <!-- MiniBus -->
  <script>
    const MiniBus = (() => {
      const wiring = {};
      const permissions = {};
      let transitionInProgress = false; // Flag to suppress re-triggering

      return {
        init() {
          MiniState.init();
        },

        wire(elementId, dataAttribute, domProperty) {
          wiring[`${elementId}.${dataAttribute}`] = domProperty;
          MiniState.watch(`${elementId}.${dataAttribute}`, (newValue) => {
            this._applyStateChange(elementId, dataAttribute, newValue);
          });
        },

        grantPermission(ownerId, stateKey) {
          if (!permissions[stateKey]) permissions[stateKey] = [];
          if (!permissions[stateKey].includes(ownerId)) {
            permissions[stateKey].push(ownerId);
          }
        },

        requestStateChange(ownerId, stateKey, newValue) {
          if (transitionInProgress) return; // Exit if a transition is already in progress

          if (permissions[stateKey] && permissions[stateKey].includes(ownerId)) {
            const targetState = newValue === "true" ? "SIDEBAR_VISIBLE" : "SIDEBAR_HIDDEN";
            const targetAttributes = MiniState.predefinedStates[targetState];

            if (
              targetAttributes &&
              (targetAttributes[stateKey] === newValue || targetAttributes[stateKey] === "" || targetAttributes[stateKey] == null)
            ) {
              transitionInProgress = true; // Set flag to indicate transition in progress
              console.log(`Transition to ${targetState} matched. Applying changes...`);
              Object.keys(targetAttributes).forEach(attr => {
                MiniState.setState(attr, targetAttributes[attr]);
              });
              transitionInProgress = false; // Reset flag after completing transition
            } else {
              console.warn(`Invalid state transition for ${stateKey} to ${newValue}`);
            }
          }
        },

        _applyStateChange(elementId, dataAttribute, newValue) {
          const element = document.getElementById(elementId);
          if (!element) return;

          const domProperty = wiring[`${elementId}.${dataAttribute}`];
          if (domProperty) {
            if (domProperty === "classList.hidden") {
              newValue === "hidden" ? element.classList.add("hidden") : element.classList.remove("hidden");
            } else {
              element[domProperty] = newValue;
            }
          }
        },

        registerEvent(componentId, eventType, stateKeyToChange) {
          const element = document.getElementById(componentId);
          if (!element) return;

          element.addEventListener(eventType, () => {
            const currentValue = MiniState.getState(stateKeyToChange) === "true";
            this.requestStateChange(componentId, stateKeyToChange, (!currentValue).toString());
          });
        }
      };
    })();
  </script>
</head>
<body class="flex">

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize MiniBus
      MiniBus.init();

      // Grant permissions for button interactions
      MiniBus.grantPermission("toggleButton", "buttonComponent.data-click");
      MiniBus.grantPermission("toggleButton", "toggleButton.data-text");
      MiniBus.grantPermission("buttonComponent", "sidebarComponent.data-class");
    });
  </script>

  <div id="sidebarComponent" data-state="closed" class="bg-neutral w-64 h-full fixed top-0 left-0 flex flex-col justify-between transform transition-transform duration-300 ease-in-out z-10 hidden">
    <div class="h-16 flex items-center justify-between px-4">
      <button class="toggleSidebarButton text-accent" aria-label="Toggle Sidebar">â˜°</button>
    </div>

    <nav class="flex-1 p-4">
      <ul class="menu w-full">
        <li>sidebar entry</li>
      </ul>
    </nav>

    <script>
      MiniBus.wire("sidebarComponent", "data-class", "classList.hidden");

      MiniState.watch("buttonComponent.data-click", (value) => {
        MiniBus.requestStateChange("buttonComponent", "sidebarComponent.data-class", value === "true" ? "" : "hidden");
      });
    </script>
  </div>

  <div id="buttonComponent" data-click="false" class="flex justify-center items-center w-full h-full">
    <button id="toggleButton" class="btn btn-primary" data-text="Show Sidebar">Show Sidebar</button>

    <script>
      MiniBus.wire("toggleButton", "data-text", "textContent");
      MiniBus.registerEvent("toggleButton", "click", "buttonComponent.data-click");

      MiniState.watch("buttonComponent.data-click", (value) => {
        MiniBus.requestStateChange("buttonComponent", "toggleButton.data-text", value === "true" ? "Hide Sidebar" : "Show Sidebar");
      });
    </script>
  </div>

</body>
</html>
