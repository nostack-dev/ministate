<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MiniBus with Async Sequential State Management</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    const MiniBus = (() => {
      const state = {}, wiring = {}, watchers = {};
      let currentState = "";

      return {
        async init() {
          document.querySelectorAll('[id]').forEach(el => {
            [...el.attributes].forEach(attr => {
              if (attr.name.startsWith('data-')) state[`${el.id}.${attr.name}`] = attr.value;
            });
          });
          console.log('Initial State:', JSON.stringify(state, null, 2));
        },

        wire(id, dataAttr, prop) { wiring[`${id}.${dataAttr}`] = prop; },
        
        watch(stateKey, callback) {
          if (!watchers[stateKey]) watchers[stateKey] = [];
          watchers[stateKey].push(callback);
        },

        async requestStateChange(id, stateKey, newValue) {
          console.log(`State change: ${id} -> ${stateKey}: ${newValue}`);
          if (state[stateKey] !== newValue) {
            state[stateKey] = newValue;
            await this._applyStateChange(stateKey, newValue);
            if (watchers[stateKey]) {
              for (const cb of watchers[stateKey]) {
                await cb(newValue); // Await each watcher callback sequentially
              }
            }
            await this.delayedCheckTransitions(); // Run delayed check for transitions
          }
        },

        async _applyStateChange(stateKey, newValue) {
          const [id, attr] = stateKey.split('.');
          const el = document.getElementById(id), prop = wiring[stateKey];
          if (!el) return;
          if (prop === "classList.hidden") {
            newValue === "hidden" ? el.classList.add("hidden") : el.classList.remove("hidden");
          } else {
            el.setAttribute(attr, newValue);
          }
        },

        registerEvent(id, eventType, stateKey) {
          document.getElementById(id).addEventListener(eventType, async () => {
            const current = state[stateKey] === "true";
            await this.requestStateChange(id, stateKey, (!current).toString());
          });
        },

        // Debounced check to handle transitions only after all state changes complete
        delayedCheckTransitions: (() => {
          let timeout;
          return async function () {
            clearTimeout(timeout);
            timeout = setTimeout(() => this.checkTransitions(), 50);
          };
        })(),

        async checkTransitions() {
          for (const [stateName, def] of Object.entries(STATES)) {
            const allMatch = Object.entries(def).every(([key, value]) => {
              if (key === "sidebarComponent.data-class") {
                // Custom check for Tailwind "hidden" class in classList
                const isHidden = document.getElementById("sidebarComponent").classList.contains("hidden");
                const expectedHidden = value === "hidden";
                if (isHidden !== expectedHidden) {
                  console.log(`Mismatch for ${stateName}: expected sidebarComponent to be "${value}", but visibility is ${isHidden ? "hidden" : "visible"}`);
                  return false;
                }
                return true;
              }
              const matches = state[key] === value;
              if (!matches) {
                console.log(`Mismatch for ${stateName}: expected ${key} to be "${value}", but found "${state[key]}"`);
              }
              return matches;
            });

            if (allMatch) {
              if (currentState !== stateName) {
                currentState = stateName;
                console.log(`Transition to State: ${currentState}`, JSON.stringify(state, null, 2));
              }
              return; // Exit after finding a matching state
            }
          }
          console.log("No predefined state matched.");
        }
      };
    })();

    const STATES = {
      SIDEBAR_HIDDEN: {
        "sidebarComponent.data-class": "hidden",
        "toggleButton.data-click": "false",
        "toggleButton.data-text": "Show Sidebar"
      },
      SIDEBAR_VISIBLE: {
        "sidebarComponent.data-class": "",
        "toggleButton.data-click": "true",
        "toggleButton.data-text": "Hide Sidebar"
      }
    };

    document.addEventListener('DOMContentLoaded', async () => {
      await MiniBus.init();
    });
  </script>
</head>
<body>

<!-- Sidebar Component -->
<div id="sidebarComponent" class="w-64 p-4 mt-6 bg-base-200 hidden" data-class="hidden">
  <p>Sidebar Content</p>
  <script>
    MiniBus.wire("sidebarComponent", "data-class", "classList.hidden");
    MiniBus.watch("buttonComponent.data-click", async (value) => {
      await MiniBus.requestStateChange("sidebarComponent", "sidebarComponent.data-class", value === "true" ? "" : "hidden");
    });
  </script>
</div>

<!-- Button Component -->
<div id="buttonComponent" data-click="false">
  <button id="toggleButton" class="btn btn-primary" data-text="Show Sidebar" data-click="false">Show Sidebar</button>
  <script>
    MiniBus.wire("toggleButton", "data-text", "textContent");

    // Register click event for the buttonComponent
    MiniBus.registerEvent("buttonComponent", "click", "buttonComponent.data-click");

    MiniBus.watch("buttonComponent.data-click", async (value) => {
      await MiniBus.requestStateChange("toggleButton", "toggleButton.data-text", value === "true" ? "Hide Sidebar" : "Show Sidebar");
      await MiniBus.requestStateChange("toggleButton", "toggleButton.data-click", value); // Set toggleButton's data-click
    });
  </script>
</div>

</body>
</html>
